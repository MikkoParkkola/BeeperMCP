# Continuous Integration & Delivery

This project uses GitHub Actions for CI/CD, publishing Docker images and single-file binaries, and supply‑chain checks.

## Overview

Workflows (enabled):

- `ci.yml` – Build, test (coverage), lint, and produce Docker image tarballs as artifacts on pushes to `main` and PRs.
- `docker-publish.yml` – Build and push Docker images to GHCR on tags `v*` (and optionally manual `workflow_dispatch`).
- `release.yml` – Create a GitHub Release with auto-generated notes on tags `v*`.
- `release-binaries.yml` – Build single-file binaries (macOS x64 + arm64, Linux x64, Windows x64), generate checksums and manifest, attach to Release on tags `v*.*.*`.
- `prerelease-binaries.yml` – Build the same binaries and attach them to a prerelease on each push to `main`.
- `gitleaks.yml` – Scan for secrets on `main` and PRs.
- `sbom.yml` – Generate CycloneDX SBOM `sbom.json` for the source tree on `main`/PRs.
- `lint-quick.yml` – Fast ESLint run on PRs affecting JS/TS or lint config.

Workflows (disabled examples): `codeql.yml.disabled`, `semgrep.yml.disabled`, `actionlint.yml.disabled`, `yamllint.yml.disabled`. Enable as needed by removing `.disabled` from the filename.

## Workflow Details

### CI (`ci.yml`)

- Triggers: push to `main`, pull_request
- Steps:
  - Setup Node 22 with npm cache
  - `npm ci`, `npm run build`
  - `npm run test:coverage` (uploads `coverage/` artifact)
  - `npm run lint`
  - Build Docker image tarball via `npm run build:docker` and upload as artifact `docker-image-<version>`
- Outputs:
  - Artifacts: `coverage/`, `docker-images/*.tar`

### Docker Publish (`docker-publish.yml`)

- Triggers: tag `v*`, manual `workflow_dispatch` with `version`
- Permissions: `packages: write`
- Steps:
  - Login to GHCR
  - Build and push Docker image with tags: `:vX.Y.Z`, `:<sha>`, `:latest`
- Outputs:
  - Pushed images to `ghcr.io/<owner>/<repo>`

### Release (notes) (`release.yml`)

- Triggers: tag `v*`
- Permissions: `contents: write`
- Steps: create a GitHub Release with autogenerated notes

### Release Binaries (`release-binaries.yml`)

- Triggers: tag `v*.*.*`
- Permissions: `contents: write`
- Steps:
  - `npm ci`, `npm run build`
  - `npx pkg` to produce:
    - `build/beepermcp-macos-x64`
    - `build/beepermcp-macos-arm64`
    - `build/beepermcp-linux-x64`
    - `build/beepermcp-win-x64.exe`
  - Move to `artifacts/`, compute `checksums.txt` (SHA-256), and generate `manifest.json`:
    - `{ "version": "<tag without v>", "assets": [{ "name", "platform", "size", "sha256" }] }`
  - Upload artifacts to the same tag’s GitHub Release
- Outputs:
  - Release assets: binaries, `checksums.txt`, `manifest.json`

Internal notes:

- Uses `GITHUB_REF_NAME` to set manifest `version` from the tag.
- Requires `softprops/action-gh-release` (uses `GITHUB_TOKEN`).

### Prerelease Binaries (`prerelease-binaries.yml`)

- Triggers: push to `main`
- Permissions: `contents: write`
- Steps:
  - Same build and artifact generation as Release Binaries
  - Creates a prerelease with tag `prerelease-<sha>` and attaches assets
- Outputs:
  - Prerelease assets: binaries, `checksums.txt`, `manifest.json`

### Gitleaks (`gitleaks.yml`)

- Triggers: push to `main`, pull_request
- Steps: run `gitleaks detect` against the working tree
- Outputs: workflow status only (fails build on detected secrets)

### SBOM (`sbom.yml`)

- Triggers: push to `main`, pull_request
- Steps: generate CycloneDX SBOM using `@cyclonedx/cdxgen`, upload artifact `sbom.json`
- Outputs: SBOM artifact

### Lint (quick) (`lint-quick.yml`)

- Triggers: pull_request (selected paths)
- Steps: Node 20, `npm ci`, `npm run lint`
- Outputs: workflow status only

## Permissions & Secrets

- Most workflows use the default `GITHUB_TOKEN`. For release asset upload and GHCR pushes, workflows set `contents: write` or `packages: write` as needed.
- No additional repository secrets are required by default. If you enable CodeQL/Semgrep or other scanners, follow their setup docs for permissions.

## Binary Auto‑Update Integration

- Binaries retrieve updates from GitHub Releases using `manifest.json` and `checksums.txt` published by the workflows above.
- Set `BEEPERMCP_UPDATE_REPO=owner/repo` or ensure `package.json.repository` is a GitHub URL.
- On macOS/Linux, the running binary is atomically replaced; on Windows a `*.new.exe` is staged and swapped on next start.
